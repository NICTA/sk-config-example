#
# Copyright 2014, NICTA
#
# This software may be distributed and modified according to the terms of
# the BSD 2-Clause license. Note that NO WARRANTY is provided.
# See "LICENSE_BSD2.txt" for details.
#
# @TAG(NICTA_BSD)
#

# keep the c and h files generated by sk-capdl hanging around
.SECONDARY:

# Cell name.
ME=$(notdir ${SOURCE_DIR})

# The sk-capdl tool generates two output files that are relevant to us,
# cell*_driver.h and cell*_driver.c. We need to generate the header before
# compiling sources of this app as they may attempt to include it, hence why we
# add SK_HEADER to the priority targets below.
SK_HEADER=${STAGE_DIR}/include/$(notdir ${SOURCE_DIR})/${ME}_driver.h
SK_SOURCE=${BUILD_DIR}/src/${ME}_driver.c

# Targets
PRIORITY_TARGETS := ${SK_HEADER}
TARGETS := ${ME}.bin

# Source files required to build the target
CFILES   := $(patsubst $(SOURCE_DIR)/%,%,$(wildcard $(SOURCE_DIR)/src/*.c)) \
    $(patsubst $(SOURCE_DIR)/%,%,$(wildcard $(SOURCE_DIR)/src/*/*.c))

CRT0=${BUILD_DIR}/src/arch/${ARCH}/crt0.S

ASMFILES := ${CRT0}

CFILES += ${SK_SOURCE}

# Always link against libsk
LIBS = sk

ifdef CONFIG_DEBUG_BUILD
# The debug build links against libmuslc, for printf() etc. for debug tracing
LIBS += muslc sel4muslcsys sel4platsupport platsupport
else
# The non-debug build links instead against just libskc
LIBS += skc
# The headers for libskc are placed specially to avoid clashing with those
# of the libc (see libskc Makefile).
# Ensure these get included in preference to those of libmuslc
# because, by the time the cells get built, libmuslc will already have been
# built and its headers already staged.
SEL4_INCLUDEDIR := $(STAGE_DIR)/include-libskc $(STAGE_DIR)/include
endif

INCLUDE_DIRS := $(dir ${SK_HEADER})

include $(SEL4_COMMON)/common.mk

${SK_HEADER}: ${SK_INPUT}
	@echo " [GEN] $(notdir $@)"
	${Q}mkdir -p $(dir $@)
	${Q}cd $(dir $@) && sk-capdl --${ARCH} --xml $< --output header --cell ${ME}

${SK_SOURCE}: ${SK_INPUT}
	@echo " [GEN] $(notdir $@)"
	${Q}mkdir -p $(dir $@)
	${Q}cd $(dir $@) && sk-capdl --${ARCH} --xml $< --output source --cell ${ME}

# Always use crt0.S from libskc for _start
${CRT0}: ${LIBSKC_SRC}/arch/${ARCH}/crt0.S
	@echo " [CP] $@"
	${Q}mkdir -p $(dir $@)
	${Q}cp -a $< $@
